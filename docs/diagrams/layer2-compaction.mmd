%% Layer 2: Compaction (Summarization)
%% Detailed compact flow

flowchart TD
    Start([compact messages, range]) --> Slice[Extract messages in range<br/>messages.slice start, end+1]

    Slice --> Par1[Extract info in parallel]

    Par1 --> ExtFiles[extractFilesModified<br/>Iterate tool_use blocks<br/>Collect Write/Edit file_path]
    Par1 --> ExtTools[extractToolUsage<br/>Count each tool usage<br/>Record top 3 notable uses]
    Par1 --> ExtDecisions[extractKeyDecisions<br/>Find sentences with decision keywords<br/>decided/chose/will use/going with]

    ExtFiles --> BuildPrompt[Build continuation prompt]
    ExtTools --> BuildPrompt
    ExtDecisions --> BuildPrompt

    BuildPrompt --> FormatConv[Format conversation history:<br/>role idx: content 500 chars]
    FormatConv --> CreatePrompt[Prompt template:<br/>Provide detailed prompt for continuing...<br/>Focus on:<br/>1. What we accomplished<br/>2. Current work<br/>3. Files modified + changes<br/>4. Next steps<br/>5. Important context/decisions]

    CreatePrompt --> CallLLM[provider.complete<br/>model: config.model<br/>max_tokens: 1500]
    CallLLM --> ExtractText[Extract text content<br/>from response.content]

    ExtractText --> CreateSum[Create ConversationSummary]
    CreateSum --> SetID[id: sum-timestamp-random]
    CreateSum --> SetType[type: compaction]
    CreateSum --> SetRange[coveringMessages: start, end]
    CreateSum --> SetContent[content: continuation prompt]
    CreateSum --> SetMeta[metadata: decisions, files, tools]
    CreateSum --> EstTokens[estimatedTokens: content.length / 4]
    CreateSum --> SetTime[generatedAt: ISO timestamp]

    SetID --> Return[Return ConversationSummary]
    SetType --> Return
    SetRange --> Return
    SetContent --> Return
    SetMeta --> Return
    EstTokens --> Return
    SetTime --> Return

    style CallLLM fill:#ff6b6b,stroke:#333,stroke-width:2px
    style CreatePrompt fill:#74c0fc
    style Return fill:#51cf66
