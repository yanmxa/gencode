# GenCode Skill System Architecture

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    GenCode Skill System                                  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                     1. 启动加载流程                                       │
└─────────────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐
    │   main.go   │
    │  启动程序    │
    └──────┬──────┘
           │
           ▼
    ┌─────────────────┐
    │ skill.Initialize│
    │   (cwd)         │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────────────────────────────────────────────────────────────────────┐
    │                            Loader.LoadAll()                                      │
    │  ┌───────────────────────────────────────────────────────────────────────────┐  │
    │  │                    搜索路径 (优先级从低到高)                                │  │
    │  │                                                                           │  │
    │  │  1. ~/.claude/skills/           (ScopeClaudeUser)     ─┐                  │  │
    │  │  2. ~/.claude/plugins/*/skills/ (ScopeUserPlugin)      │ Claude 兼容      │  │
    │  │  3. ~/.gen/plugins/*/skills/    (ScopeUserPlugin)      │                  │  │
    │  │  4. ~/.gen/skills/              (ScopeUser)            ├─ 用户级别        │  │
    │  │  5. .claude/skills/             (ScopeClaudeProject)   │                  │  │
    │  │  6. .claude/plugins/*/skills/   (ScopeProjectPlugin)   │                  │  │
    │  │  7. .gen/plugins/*/skills/      (ScopeProjectPlugin)   ├─ 项目级别        │  │
    │  │  8. .gen/skills/                (ScopeProject)        ─┘ (最高优先级)     │  │
    │  │                                                                           │  │
    │  └───────────────────────────────────────────────────────────────────────────┘  │
    └────────────────────────────────────┬────────────────────────────────────────────┘
                                         │
                                         ▼
    ┌─────────────────────────────────────────────────────────────────────────────────┐
    │                         loadSkillFile() 解析每个 SKILL.md                        │
    │  ┌─────────────────────────────────────────────────────────────────────────┐    │
    │  │  skill-name/                                                            │    │
    │  │  ├── SKILL.md          ───────────────────────────────────────────┐     │    │
    │  │  │   ---                                                          │     │    │
    │  │  │   name: my-skill           ◄── 解析 YAML frontmatter           │     │    │
    │  │  │   description: ...         ◄── name, description, allowed-tools│     │    │
    │  │  │   allowed-tools: [Bash]    ◄── argument-hint, namespace        │     │    │
    │  │  │   ---                                                          │     │    │
    │  │  │   # Instructions           ◄── Markdown 内容 (lazy load)       │     │    │
    │  │  │   ...                                                          │     │    │
    │  │  ├── scripts/          ◄── scanResourceDir() 扫描                 │     │    │
    │  │  │   └── run.py                                                   │     │    │
    │  │  ├── references/       ◄── scanResourceDir() 扫描                 │     │    │
    │  │  │   └── API.md                                                   │     │    │
    │  │  └── assets/           ◄── scanResourceDir() 扫描                 │     │    │
    │  │      └── template.docx                                            │     │    │
    │  └─────────────────────────────────────────────────────────────────────────┘    │
    └────────────────────────────────────┬────────────────────────────────────────────┘
                                         │
                                         ▼
    ┌─────────────────────────────────────────────────────────────────────────────────┐
    │                              Registry (全局注册表)                                │
    │  ┌─────────────────────────────────────────────────────────────────────────┐    │
    │  │  skills map[string]*Skill     ◄── 按 FullName (namespace:name) 索引     │    │
    │  │  userStore *Store             ◄── ~/.gen/skills.json 状态持久化         │    │
    │  │  projectStore *Store          ◄── .gen/skills.json 状态持久化           │    │
    │  └─────────────────────────────────────────────────────────────────────────┘    │
    │                                                                                  │
    │  方法:                                                                           │
    │  • Get(name) → *Skill            查找 skill                                     │
    │  • FindByPartialName(name)       模糊查找 (commit → git:commit)                 │
    │  • GetEnabled() → []*Skill       获取启用的 skills                              │
    │  • GetActive() → []*Skill        获取激活的 skills (model-aware)                │
    │  • SetState(name, state)         设置状态并持久化                                │
    │  • GetAvailableSkillsPrompt()    生成 system prompt                             │
    └─────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                   2. Skill 状态管理                                      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────────────┐
    │                              三种状态                                            │
    │                                                                                  │
    │   ○ disable    ────────►  ◐ enable    ────────►  ● active   ────────►  (循环)   │
    │   (禁用)                   (启用)                  (激活)                         │
    │   • 不可见                 • 可见                  • 可见                         │
    │   • 无法调用               • 用户可调用            • 用户可调用                   │
    │                            • /skill-name          • LLM 可主动调用               │
    │                                                   • 元数据在 system prompt       │
    └─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────────────┐
    │                           状态持久化                                             │
    │                                                                                  │
    │   ~/.gen/skills.json (用户级)      .gen/skills.json (项目级, 优先)               │
    │   {                                {                                             │
    │     "skills": {                      "skills": {                                 │
    │       "git:commit": "active",          "my-skill": "enable"                      │
    │       "pdf": "enable"                }                                           │
    │     }                              }                                             │
    │   }                                                                              │
    └─────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                   3. Skill 调用流程                                      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────────────────────────────┐
    │                          方式 A: 用户 Slash 命令                                  │
    │                                                                                   │
    │   用户输入: /commit -m "Fix bug"                                                  │
    │                │                                                                  │
    │                ▼                                                                  │
    │   ┌───────────────────────┐                                                       │
    │   │  ExecuteCommand()     │                                                       │
    │   │  ParseCommand()       │                                                       │
    │   └───────────┬───────────┘                                                       │
    │               │                                                                   │
    │               ▼                                                                   │
    │   ┌───────────────────────┐                                                       │
    │   │  IsSkillCommand()     │ ◄── 检查是否是注册的 skill                            │
    │   │  skill.Get("commit")  │                                                       │
    │   └───────────┬───────────┘                                                       │
    │               │                                                                   │
    │               ▼                                                                   │
    │   ┌───────────────────────────────────────────────────────────────────────────┐  │
    │   │  executeSkillCommand()                                                    │  │
    │   │  • GetSkillInvocationPrompt() ◄── 获取完整指令包装为 XML                   │  │
    │   │  • pendingSkillInstructions   ◄── 注入到下一轮对话                         │  │
    │   │  • pendingSkillArgs           ◄── 用户参数                                 │  │
    │   └───────────────────────────────────────────────────────────────────────────┘  │
    └──────────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────────────────────────────┐
    │                          方式 B: LLM 工具调用 (新增)                              │
    │                                                                                   │
    │   LLM 调用: Skill(skill="commit", args="-m 'Fix bug'")                           │
    │                │                                                                  │
    │                ▼                                                                  │
    │   ┌───────────────────────┐                                                       │
    │   │  SkillTool.Execute()  │                                                       │
    │   └───────────┬───────────┘                                                       │
    │               │                                                                   │
    │               ▼                                                                   │
    │   ┌───────────────────────────────────────────────────────────────────────────┐  │
    │   │  1. Registry.Get(skillName)        查找 skill                             │  │
    │   │  2. FindByPartialName(skillName)   模糊匹配 (commit → git:commit)         │  │
    │   │  3. 检查 IsEnabled()               必须启用                                │  │
    │   │  4. GetInstructions()              加载完整指令                            │  │
    │   └───────────┬───────────────────────────────────────────────────────────────┘  │
    │               │                                                                   │
    │               ▼                                                                   │
    │   ┌───────────────────────────────────────────────────────────────────────────┐  │
    │   │  构建 <skill-invocation> 响应:                                            │  │
    │   │                                                                           │  │
    │   │  <skill-invocation name="git:commit">                                     │  │
    │   │  User arguments: -m 'Fix bug'                                             │  │
    │   │                                                                           │  │
    │   │  Available scripts (use Bash to execute):                                 │  │
    │   │    - /path/to/skill/scripts/commit.sh                                     │  │
    │   │                                                                           │  │
    │   │  Reference files (use Read when needed):                                  │  │
    │   │    - /path/to/skill/references/CONVENTIONS.md                             │  │
    │   │                                                                           │  │
    │   │  [SKILL.md 内容...]                                                       │  │
    │   │  </skill-invocation>                                                      │  │
    │   └───────────────────────────────────────────────────────────────────────────┘  │
    │               │                                                                   │
    │               ▼                                                                   │
    │   ┌───────────────────────┐                                                       │
    │   │  返回给 LLM           │ ◄── LLM 根据指令执行任务                              │
    │   │  继续对话流程          │                                                       │
    │   └───────────────────────┘                                                       │
    └──────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                   4. System Prompt 集成                                  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────────────┐
    │                         渐进式加载 (Progressive Loading)                         │
    │                                                                                  │
    │   Level 1: System Prompt (始终包含)                                              │
    │   ┌────────────────────────────────────────────────────────────────────────┐    │
    │   │  # Available Skills                                                    │    │
    │   │                                                                        │    │
    │   │  Use the Skill tool to invoke these capabilities:                      │    │
    │   │                                                                        │    │
    │   │  - **git:commit**: Create git commits with DCO sign-off [2 scripts]   │    │
    │   │  - **pdf**: Process PDF files [3 scripts, 2 refs]                      │    │
    │   │  - **my-skill**: Do something useful                                   │    │
    │   │                                                                        │    │
    │   │  Invoke with: Skill(skill="name", args="optional args")               │    │
    │   └────────────────────────────────────────────────────────────────────────┘    │
    │                                                                                  │
    │   Level 2: Skill 调用时加载 (按需)                                               │
    │   ┌────────────────────────────────────────────────────────────────────────┐    │
    │   │  <skill-invocation name="git:commit">                                  │    │
    │   │  [完整 SKILL.md 内容]                                                   │    │
    │   │  [Scripts/References 路径]                                              │    │
    │   │  </skill-invocation>                                                   │    │
    │   └────────────────────────────────────────────────────────────────────────┘    │
    │                                                                                  │
    │   Level 3: LLM 按需读取 (使用 Read/Bash 工具)                                    │
    │   ┌────────────────────────────────────────────────────────────────────────┐    │
    │   │  - Read: /path/skill/references/API.md                                 │    │
    │   │  - Bash: python /path/skill/scripts/process.py                         │    │
    │   └────────────────────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                   5. 完整数据流                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

    ┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
    │   用户     │     │   TUI      │     │   LLM      │     │   工具     │
    └─────┬──────┘     └─────┬──────┘     └─────┬──────┘     └─────┬──────┘
          │                  │                  │                  │
          │  启动 ./gen      │                  │                  │
          ├─────────────────►│                  │                  │
          │                  │                  │                  │
          │                  │ skill.Initialize()                  │
          │                  ├──────────────────────────────────────►
          │                  │ 加载所有 skills                      │
          │                  │◄──────────────────────────────────────
          │                  │                  │                  │
          │  "help me commit"│                  │                  │
          ├─────────────────►│                  │                  │
          │                  │                  │                  │
          │                  │ System Prompt    │                  │
          │                  │ + Available Skills                  │
          │                  ├─────────────────►│                  │
          │                  │                  │                  │
          │                  │                  │ Skill(skill="commit")
          │                  │                  ├─────────────────►│
          │                  │                  │                  │
          │                  │                  │ <skill-invocation>
          │                  │                  │◄─────────────────┤
          │                  │                  │                  │
          │                  │                  │ Bash(commit.sh)  │
          │                  │                  ├─────────────────►│
          │                  │                  │                  │
          │                  │                  │ 执行结果          │
          │                  │                  │◄─────────────────┤
          │                  │                  │                  │
          │                  │ 完成消息         │                  │
          │                  │◄─────────────────┤                  │
          │                  │                  │                  │
          │  显示结果        │                  │                  │
          │◄─────────────────┤                  │                  │
          │                  │                  │                  │
```

---

## Skill 结构体详解

```go
type Skill struct {
    // Frontmatter (YAML)
    Name         string   // skill 名称
    Namespace    string   // 命名空间 (git, jira, etc.)
    Description  string   // 描述 (用于 system prompt)
    AllowedTools []string // 允许的工具
    ArgumentHint string   // 参数提示

    // Runtime
    FilePath     string     // SKILL.md 路径
    SkillDir     string     // skill 目录路径
    Scope        SkillScope // 作用域
    Instructions string     // Markdown 内容
    State        SkillState // 状态 (disable/enable/active)

    // Resources (Agent Skills Spec)
    Scripts    []string // scripts/ 目录中的文件
    References []string // references/ 目录中的文件
    Assets     []string // assets/ 目录中的文件
}
```

---

## 与 Agent Skills 规范对齐

| Agent Skills Spec | GenCode 实现 | 状态 |
|-------------------|--------------|------|
| SKILL.md 格式 | ✓ | 完全兼容 |
| name/description | ✓ | 完全兼容 |
| scripts/ 目录 | ✓ | 扫描并列出路径 |
| references/ 目录 | ✓ | 扫描并列出路径 |
| assets/ 目录 | ✓ | 扫描并列出路径 |
| 渐进式加载 | ✓ | 只加载元数据到 prompt |
| Skill 工具 | ✓ | LLM 可调用 |
| .skill 打包 | ✗ | 未实现 (可选) |
